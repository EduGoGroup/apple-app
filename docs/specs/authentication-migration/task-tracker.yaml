spec:
  id: SPEC-003
  name: Authentication - Real API Migration
  priority: P1_HIGH
  status: IN_PROGRESS
  completion_percentage: 90%
  estimated_hours: 15
  actual_hours: 13
  dependencies: [SPEC-001, SPEC-002]
  started_date: 2025-11-22
  updated_date: 2025-11-25

# üü¢ 90% COMPLETADO - Actualizado 2025-11-25

implementation:
  completed:
    - name: "JWTDecoder"
      file: "/Data/Services/Auth/JWTDecoder.swift"
      status: "‚úÖ Implementado completo"
      features:
        - "Decodifica estructura JWT (3 segmentos)"
        - "Valida claims: sub, email, role, exp, iat, iss"
        - "Valida issuer: edugo-central, edugo-mobile"
        - "Valida expiraci√≥n"
      limitations:
        - "‚ö†Ô∏è NO valida firma criptogr√°fica (aplazado)"
      reason: "Requiere clave p√∫blica del servidor (backend pendiente)"

    - name: "TokenRefreshCoordinator"
      file: "/Data/Services/Auth/TokenRefreshCoordinator.swift"
      status: "‚úÖ Implementado con Actor"
      features:
        - "Actor para evitar race conditions"
        - "Auto-refresh 2min antes de expirar"
        - "Coordina m√∫ltiples requests concurrentes"
      integration: "‚úÖ INTEGRADO en AuthInterceptor"

    - name: "BiometricAuthService"
      file: "/Data/Services/Auth/BiometricAuthService.swift"
      status: "‚úÖ Implementado completo"
      features:
        - "Face ID support"
        - "Touch ID support"
        - "Availability check"
        - "Error handling robusto"
      integration: "‚úÖ INTEGRADO en LoginWithBiometricsUseCase"

    - name: "LoginWithBiometricsUseCase"
      file: "/Domain/UseCases/Auth/LoginWithBiometricsUseCase.swift"
      status: "‚úÖ Implementado y registrado en DI"
      flow:
        - "1. Check biometric availability"
        - "2. Authenticate con LocalAuthentication"
        - "3. Retrieve stored credentials"
        - "4. Login autom√°tico"

    - name: "DTOs para API Real"
      status: "‚úÖ Todos implementados"
      files:
        - "/Data/DTOs/Auth/LoginDTO.swift"
        - "/Data/DTOs/Auth/RefreshDTO.swift"
        - "/Data/DTOs/Auth/LogoutDTO.swift"
      note: "Alineados con edugo-central API"

    - name: "AuthInterceptor con Auto-Refresh"
      file: "/Data/Network/Interceptors/AuthInterceptor.swift"
      status: "‚úÖ Implementado y funcional"
      code: |
        func intercept(_ request: URLRequest) async throws -> URLRequest {
            let tokenInfo = try await tokenRefreshCoordinator.getValidToken()
            // ‚úÖ Auto-refresh transparente
            var mutableRequest = request
            mutableRequest.setValue("Bearer \(tokenInfo.accessToken)",
                                   forHTTPHeaderField: "Authorization")
            return mutableRequest
        }

    - name: "UI Biom√©trica en LoginView"
      file: "/Presentation/Scenes/Auth/Login/LoginView.swift"
      status: "‚úÖ Implementado"
      code: |
        if viewModel.isBiometricAvailable {
            DSButton(title: "Usar Face ID", style: .secondary) {
                await viewModel.loginWithBiometrics()
            }
        }

    - name: "DI sin Dependencias Circulares"
      file: "/apple-app/apple_appApp.swift"
      status: "‚úÖ Refactorizado y funcional"
      strategy:
        - "registerBaseServices() primero"
        - "registerAuthServices() despu√©s"
        - "registerAPIClient() con interceptors"
        - "registerRepositories() al final"

  pending:
    - name: "JWT Signature Validation"
      estimated_hours: 2
      status: "‚è∏Ô∏è APLAZADO"
      reason: "Requiere clave p√∫blica del servidor"
      blocker: "Backend debe exponer endpoint /.well-known/jwks.json"
      implementation_needed: |
        - Fetch public key desde servidor
        - Validar firma con CryptoKit
        - Cachear clave p√∫blica

    - name: "Tests E2E con API Real"
      estimated_hours: 1
      status: "‚è∏Ô∏è OMITIDO"
      reason: "No hay ambiente staging disponible"
      alternative: "Tests con mocks cubren flujo completo"

evidence:
  auto_refresh_integration: |
    // AuthInterceptor.swift - VERIFICADO
    actor AuthInterceptor: RequestInterceptor {
        private let tokenRefreshCoordinator: TokenRefreshCoordinator

        func intercept(_ request: URLRequest) async throws -> URLRequest {
            // ‚úÖ Auto-refresh autom√°tico
            let tokenInfo = try await tokenRefreshCoordinator.getValidToken()
            request.setValue("Bearer \(tokenInfo.accessToken)", ...)
        }
    }

  biometric_ui: |
    // LoginView.swift - VERIFICADO
    @Observable
    final class LoginViewModel {
        var isBiometricAvailable: Bool {
            biometricAuthService.canAuthenticate()
        }

        func loginWithBiometrics() async {
            // ‚úÖ Flujo completo implementado
            await loginWithBiometricsUseCase.execute()
        }
    }

  jwt_decoder: |
    // JWTDecoder.swift - VERIFICADO
    func decode(_ token: String) throws -> JWTPayload {
        // ‚úÖ Valida estructura, claims, issuer, expiraci√≥n
        // ‚ö†Ô∏è NO valida firma (pendiente clave p√∫blica)
    }

tests:
  unit_tests:
    - "JWTDecoderTests (estructura y claims) ‚úÖ"
    - "TokenRefreshCoordinatorTests (race conditions) ‚úÖ"
    - "BiometricAuthServiceTests ‚úÖ"
    - "LoginWithBiometricsUseCaseTests ‚úÖ"
    - "AuthInterceptorTests ‚úÖ"

  integration_tests:
    - "AuthFlowIntegrationTests (con mocks) ‚úÖ"

  e2e_tests:
    - "API Real E2E Tests ‚è∏Ô∏è Pendiente (no hay staging)"

documentation:
  completed:
    - "PLAN-EJECUCION-SPEC-003.md ‚úÖ"
    - "SPEC-003-ESTADO-ACTUAL.md (v1.1) ‚úÖ"

  pending:
    - "SPEC-003-COMPLETADO.md (cuando llegue a 100%)"

blockers:
  external:
    - issue: "JWT Signature Validation"
      blocker: "Backend debe exponer clave p√∫blica"
      contact: "Equipo Backend"
      estimated_resolution: "TBD"

    - issue: "E2E Tests con API Real"
      blocker: "No existe ambiente staging"
      contact: "DevOps"
      estimated_resolution: "TBD"

next_steps:
  when_backend_ready:
    - "Implementar JWT signature validation (2h)"
    - "Tests E2E con staging (1h)"
    - "Actualizar a COMPLETED 100%"

notes: |
  üü¢ SPEC AL 90% - FUNCIONAL EN PRODUCCI√ìN

  Lo implementado es suficiente para producci√≥n:
  ‚úÖ Auto-refresh autom√°tico funciona
  ‚úÖ Login biom√©trico integrado en UI
  ‚úÖ JWTDecoder valida estructura y claims
  ‚úÖ DI sin dependencias circulares

  Lo pendiente (10%) est√° bloqueado externamente:
  ‚è∏Ô∏è JWT signature requiere backend
  ‚è∏Ô∏è E2E tests requiere ambiente staging

  Criterios de aceptaci√≥n cumplidos:
  ‚úÖ Auto-refresh sin race conditions
  ‚úÖ Biometric login funcional
  ‚úÖ AuthInterceptor auto-inject
  ‚ö†Ô∏è JWT validation (estructura s√≠, firma pendiente)

  Pr√≥ximo paso: Esperar backend para completar al 100%
